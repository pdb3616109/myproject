<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šåœ°å€æŒä»“èšåˆæŸ¥è¯¢å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* è½§å·®è¡Œçš„é«˜äº®æ ·å¼ */
        .net-row {
            background-color: #f8fafc;
            border-top: 2px dashed #e2e8f0;
            font-weight: 600;
        }
        /* è¯¦æƒ…è¡Œè¿‡æ¸¡åŠ¨ç”» */
        .detail-row {
            transition: all 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="p-3 bg-blue-100 text-blue-600 rounded-lg">
                    <i data-lucide="layers" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">å¤šåœ°å€æŒä»“èšåˆæŸ¥è¯¢</h1>
                    <p class="text-sm text-gray-500">è¾“å…¥é’±åŒ…åœ°å€(å¯å¸¦å¤‡æ³¨)ï¼Œè‡ªåŠ¨æ±‡æ€»æŒä»“æ•°é‡å¹¶è¿›è¡Œå¯¹å†²åˆ†æ (å¿½ç•¥æ•°é‡ < 5)</p>
                </div>
            </div>
            <div class="text-right text-sm text-gray-500">
                <span id="status-text">å°±ç»ª</span>
            </div>
        </header>

        <!-- Input Section -->
        <section class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-medium text-gray-700">
                    é’±åŒ…åœ°å€åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªåœ°å€ï¼Œæ”¯æŒå¤‡æ³¨)
                </label>
                <button onclick="loadDefaultAddresses()" class="text-xs text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1">
                    <i data-lucide="upload" class="w-3 h-3"></i> åŠ è½½é»˜è®¤/æµ‹è¯•åœ°å€
                </button>
            </div>
            <textarea id="addressInput" rows="8" 
                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm transition-all"
                placeholder="æ ¼å¼ç¤ºä¾‹ï¼š&#10;0x123...abc (æˆ‘çš„é’±åŒ…1)&#10;0x456...def (å¤‡ç”¨è´¦æˆ·)&#10;..."></textarea>
            
            <div class="mt-4 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="useProxy" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="useProxy" class="text-sm text-gray-600 cursor-pointer select-none" title="å¦‚æœé‡åˆ°è·¨åŸŸ(CORS)é”™è¯¯ï¼Œè¯·å‹¾é€‰æ­¤é¡¹">
                        ä½¿ç”¨ CORS ä»£ç† (å¦‚æœè¯·æ±‚å¤±è´¥è¯·å‹¾é€‰)
                    </label>
                </div>
                <div class="flex gap-3">
                    <button onclick="clearInput()" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        æ¸…ç©º
                    </button>
                    <button onclick="startQuery()" id="queryBtn" class="flex items-center gap-2 px-6 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-md transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="search" class="w-4 h-4"></i>
                        å¼€å§‹æŸ¥è¯¢
                    </button>
                </div>
            </div>
        </section>

        <!-- Loading State -->
        <div id="loading" class="hidden flex flex-col items-center justify-center py-12">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-500 text-sm">æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™... (<span id="progress-count">0/0</span>)</p>
        </div>

        <!-- Error Message -->
        <div id="error-msg" class="hidden p-4 bg-red-50 text-red-700 border border-red-200 rounded-lg text-sm"></div>

        <!-- Results Section -->
        <section id="results" class="hidden space-y-4 fade-in">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-lg font-bold text-gray-800">èšåˆç»“æœ</h2>
                    <p class="text-sm text-gray-500">å…±æ‰¾åˆ° <span id="total-groups" class="font-bold text-blue-600">0</span> ä¸ªç¬¦åˆæ¡ä»¶çš„æŒä»“ (å·²éšè—æ•°é‡ < 5)</p>
                </div>
                <button onclick="exportCSV()" class="flex items-center gap-2 px-4 py-2 text-sm text-green-700 bg-green-50 border border-green-200 hover:bg-green-100 rounded-lg transition-colors">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    å¯¼å‡º CSV
                </button>
            </div>

            <div class="overflow-x-auto bg-white rounded-xl shadow-sm border border-gray-200">
                <table class="w-full text-left border-collapse table-fixed">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider border-b border-gray-200">
                            <th class="p-4 font-semibold w-8"></th> <!-- å±•å¼€å›¾æ ‡ -->
                            <th class="p-4 font-semibold w-1/3">é¢„æµ‹æ ‡é¢˜ (Mutil Title)</th>
                            <th class="p-4 font-semibold w-1/3">ç›¸å…³äº‹ä»¶ (Topic)</th>
                            <th class="p-4 font-semibold text-center w-24">ç»“æœ</th>
                            <th class="p-4 font-semibold text-right w-32">æ€»æ•°é‡</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody" class="text-sm divide-y divide-gray-100">
                        <!-- JS æ³¨å…¥è¡Œ -->
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <script>
        // åˆå§‹åŒ–å›¾æ ‡
        lucide.createIcons();

        // é»˜è®¤åœ°å€å¸¸é‡ (å¸¦å¤‡æ³¨)
        const DEFAULT_ADDRESSES = `0x71bbe4372bce22fbe590812f1e0fbcd740fa87b9(bn)
0x6f743423b03ab58b15aea9adb2c839e19e7809ad(gg)
0x96525bd07982fe36c79c1d62a0a3552bd49c1c2d(ok1)
0xfc303904f04e4c394a49427fbbb91a3c0d0c0ad3(bn1)
0xb47a66c169d1f2a3140ee1d2bf42263814220ab4(bn2)
0x2612203ca224aa104712d437df6149a54848550d(bn3)
0x7c21a247b35d5002bf3c3d936ed1098ab4fad7a3(bn4)
0x856190554b078b28eff70ded0ac98b0e325d377d(ok2)
0xff10178771a773700a9efbe00998d2139e307058(ok3)`;

        // çŠ¶æ€å˜é‡
        let aggregatedDataForExport = []; // ä¸“é—¨ç”¨äºå¯¼å‡ºçš„æ•°æ®
        let isProcessing = false;

        // åŠ è½½é»˜è®¤åœ°å€
        function loadDefaultAddresses() {
            document.getElementById('addressInput').value = DEFAULT_ADDRESSES;
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            document.getElementById('addressInput').value = '';
            resetUI();
        }

        // é‡ç½® UI
        function resetUI() {
            document.getElementById('results').classList.add('hidden');
            document.getElementById('error-msg').classList.add('hidden');
            document.getElementById('resultBody').innerHTML = '';
            aggregatedDataForExport = [];
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.textContent = msg;
            el.classList.remove('hidden');
        }

        // è¾…åŠ©å‡½æ•°ï¼šè§£æè¾“å…¥è¡Œï¼Œè¿”å› {address, remark}
        function parseLine(line) {
            // åŒ¹é… 0x å¼€å¤´çš„ 42 ä½åœ°å€
            const match = line.match(/(0x[a-fA-F0-9]{40})/);
            if (match) {
                const address = match[1];
                // å‰©ä½™éƒ¨åˆ†ä½œä¸ºå¤‡æ³¨ï¼Œå»é™¤åœ°å€ã€ç©ºæ ¼å’Œå¤–å±‚æ‹¬å·
                let remark = line.replace(address, '').trim();
                remark = remark.replace(/^[\(\ï¼ˆ]+|[\)\ï¼‰]+$/g, '').trim();
                return { address, remark };
            }
            return null;
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–åœ°å€æ˜¾ç¤º (å¤‡æ³¨ + ç¼©ç•¥åœ°å€)
        function formatAddressDisplay(address, remark) {
            const shortAddr = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
            if (remark) {
                return `<span class="font-bold text-gray-800">${remark}</span> <span class="text-gray-400 text-xs ml-1 font-mono">(${shortAddr})</span>`;
            }
            return `<span class="text-gray-500 font-mono">${shortAddr}</span>`;
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–åœ°å€å¯¼å‡º (ç”¨äºCSV)
        function formatAddressExport(address, remark) {
            if (remark) {
                return `${remark}(${address})`;
            }
            return address;
        }

        // æ ¸å¿ƒå¤„ç†å‡½æ•°
        async function startQuery() {
            if (isProcessing) return;

            let input = document.getElementById('addressInput').value;
            
            // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œè‡ªåŠ¨ä½¿ç”¨é»˜è®¤åœ°å€
            if (!input.trim()) {
                input = DEFAULT_ADDRESSES;
                console.log("Input empty, using default addresses.");
            }

            // è§£ææ¯ä¸€è¡Œ
            const lines = input.split('\n');
            const targetList = [];

            lines.forEach(line => {
                const parsed = parseLine(line);
                if (parsed) {
                    targetList.push(parsed);
                }
            });

            if (targetList.length === 0) {
                showError("è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆçš„é’±åŒ…åœ°å€ (æ ¼å¼: 0x... æˆ– 0x...(å¤‡æ³¨))ã€‚");
                return;
            }

            // UI çŠ¶æ€æ›´æ–°
            isProcessing = true;
            resetUI();
            const btn = document.getElementById('queryBtn');
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin mr-2">âŸ³</span> æŸ¥è¯¢ä¸­...`;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('progress-count').innerText = `0/${targetList.length}`;

            const useProxy = document.getElementById('useProxy').checked;
            
            // èšåˆå™¨ Map: Key = TokenID, Value = Object
            const aggregator = new Map();
            let successCount = 0;
            let failCount = 0;

            // å¹¶å‘å¤„ç†è¯·æ±‚
            const promises = targetList.map(async (target) => {
                const { address, remark } = target;
                try {
                    let url = `https://webfeng.org/op/getOrder?limit=100&chainId=56&page=1&walletAddress=${address}`;
                    
                    if (useProxy) {
                        url = `https://corsproxy.io/?` + encodeURIComponent(url);
                    }

                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const json = await response.json();

                    if (json && json.result && json.result.list) {
                        json.result.list.forEach(item => {
                            const tokenId = item.tokenId;
                            const amount = parseFloat(item.tokenAmount) || 0;
                            
                            // æ„é€ æ˜ç»†é¡¹
                            const detailItem = { address: address, remark: remark, amount: amount };

                            if (aggregator.has(tokenId)) {
                                const existing = aggregator.get(tokenId);
                                existing.totalAmount += amount;
                                existing.details.push(detailItem);
                            } else {
                                aggregator.set(tokenId, {
                                    tokenId: tokenId,
                                    mutilTitle: item.mutilTitle,
                                    topicTitle: item.topicTitle,
                                    outcome: item.outcome, 
                                    outcomeLabel: item.outcome,
                                    totalAmount: amount,
                                    details: [detailItem] 
                                });
                            }
                        });
                    }
                    successCount++;
                } catch (error) {
                    console.error(`Error fetching ${address}:`, error);
                    failCount++;
                } finally {
                    // æ›´æ–°è¿›åº¦
                    const finished = successCount + failCount;
                    document.getElementById('progress-count').innerText = `${finished}/${targetList.length}`;
                }
            });

            await Promise.all(promises);

            // æ¸²æŸ“ç»“æœ
            renderResults(aggregator);
            
            // æ¢å¤ UI çŠ¶æ€
            isProcessing = false;
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="search" class="w-4 h-4 mr-2"></i> å¼€å§‹æŸ¥è¯¢`;
            lucide.createIcons(); // é‡æ–°æ¸²æŸ“å›¾æ ‡
            document.getElementById('loading').classList.add('hidden');
            
            if (failCount > 0) {
                showError(`æŸ¥è¯¢å®Œæˆï¼Œä½†æœ‰ ${failCount} ä¸ªåœ°å€è¯·æ±‚å¤±è´¥ã€‚è¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®æˆ–å°è¯•å‹¾é€‰ CORS ä»£ç†ã€‚`);
            }
        }

        function renderResults(aggregator) {
            const tbody = document.getElementById('resultBody');
            const resultSection = document.getElementById('results');
            const totalGroupsEl = document.getElementById('total-groups');

            if (aggregator.size === 0) {
                showError("æœªæ‰¾åˆ°ä»»ä½•æ•°æ®ï¼Œæˆ–æ¥å£è¿”å›ä¸ºç©ºã€‚");
                return;
            }

            // 1. åˆå§‹è¿‡æ»¤ï¼šåªä¿ç•™æ•°é‡ >= 5 çš„æ¡ç›®
            const filteredData = Array.from(aggregator.values()).filter(item => item.totalAmount >= 5);

            if (filteredData.length === 0) {
                showError("æ‰€æœ‰æŒä»“æ•°é‡å‡å°äº 5ï¼Œæ— æ•°æ®å±•ç¤ºã€‚");
                return;
            }

            // ä¿å­˜è¿‡æ»¤åçš„æ•°æ®ä¾›å¯¼å‡º
            aggregatedDataForExport = filteredData;
            totalGroupsEl.innerText = filteredData.length;

            // 2. åˆ†ç»„é€»è¾‘
            const groups = {};
            filteredData.forEach(item => {
                const groupKey = (item.mutilTitle || "Unknown") + "|||" + (item.topicTitle || "Unknown");
                if (!groups[groupKey]) {
                    groups[groupKey] = [];
                }
                groups[groupKey].push(item);
            });

            // 3. æ’åº
            const sortedGroupKeys = Object.keys(groups).sort();

            // 4. æ„å»ºæ¸²æŸ“
            sortedGroupKeys.forEach(key => {
                const groupItems = groups[key];
                
                // ç»„å†…æ’åº
                groupItems.sort((a, b) => b.totalAmount - a.totalAmount);

                let yesAmount = 0;
                let noAmount = 0;
                let hasYes = false;
                let hasNo = false;

                // æ¸²æŸ“åŸå§‹è¡Œ
                groupItems.forEach(item => {
                    if (item.outcomeLabel === 'YES') { yesAmount += item.totalAmount; hasYes = true; }
                    if (item.outcomeLabel === 'NO') { noAmount += item.totalAmount; hasNo = true; }
                    
                    renderRow(tbody, item, false);
                });

                // 5. è½§å·®è¡Œ
                if (hasYes && hasNo) {
                    const net = yesAmount - noAmount;
                    const netSide = net > 0 ? 'YES' : (net < 0 ? 'NO' : 'FLAT');
                    const netAbs = Math.abs(net);

                    const analysisItem = {
                        mutilTitle: "", 
                        topicTitle: "ğŸ“Š å‡€å¤´å¯¸åˆ†æ (Net Position)",
                        outcomeLabel: netSide,
                        totalAmount: netAbs,
                        isNetRow: true
                    };
                    renderRow(tbody, analysisItem, true);
                }
            });

            resultSection.classList.remove('hidden');
            lucide.createIcons();
        }

        // åˆ‡æ¢è¯¦æƒ…è¡Œæ˜¾ç¤º
        function toggleDetails(tokenId) {
            const row = document.getElementById(`detail-${tokenId}`);
            const icon = document.getElementById(`icon-${tokenId}`);
            if (row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                icon.style.transform = 'rotate(90deg)';
            } else {
                row.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // æ¸²æŸ“å•è¡Œ
        function renderRow(tbody, item, isNetRow) {
            const tr = document.createElement('tr');
            
            // æ ·å¼å¤„ç†
            let outcomeClass = "bg-gray-100 text-gray-600";
            if (item.outcomeLabel === 'YES') outcomeClass = "bg-green-100 text-green-700 border-green-200";
            if (item.outcomeLabel === 'NO') outcomeClass = "bg-red-100 text-red-700 border-red-200";
            if (item.outcomeLabel === 'FLAT') outcomeClass = "bg-gray-200 text-gray-700 border-gray-300";

            if (isNetRow) {
                tr.className = "net-row text-gray-700";
                if (item.outcomeLabel === 'YES') outcomeClass = "bg-green-600 text-white border-green-600 shadow-sm";
                if (item.outcomeLabel === 'NO') outcomeClass = "bg-red-600 text-white border-red-600 shadow-sm";
            } else {
                tr.className = "hover:bg-gray-50 transition-colors border-b border-gray-50 cursor-pointer";
                tr.onclick = () => toggleDetails(item.tokenId); // ç‚¹å‡»æ•´è¡Œå±•å¼€
            }

            const amountClass = isNetRow ? "font-bold text-gray-900 text-base" : "font-mono font-bold text-blue-700";

            // ä¸»è¡Œ HTML
            tr.innerHTML = `
                <td class="p-4 align-top text-center text-gray-400">
                    ${!isNetRow ? `<i id="icon-${item.tokenId}" data-lucide="chevron-right" class="w-4 h-4 transition-transform duration-200"></i>` : ''}
                </td>
                <td class="p-4 align-top">
                    <div class="font-medium ${isNetRow ? 'text-gray-400' : 'text-gray-900'} line-clamp-2" title="${item.mutilTitle}">
                        ${item.mutilTitle || ''}
                    </div>
                </td>
                <td class="p-4 align-top ${isNetRow ? 'font-semibold text-gray-800 italic' : 'text-gray-600'} whitespace-nowrap">
                    ${item.topicTitle}
                </td>
                <td class="p-4 align-top text-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium border ${outcomeClass}">
                        ${isNetRow ? 'å‡€ ' + item.outcomeLabel : item.outcomeLabel}
                    </span>
                </td>
                <td class="p-4 align-top text-right ${amountClass}">
                    ${item.totalAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 6})}
                </td>
            `;
            tbody.appendChild(tr);

            // è¯¦æƒ…è¡Œ HTML (ä»…é Net Row æœ‰)
            if (!isNetRow) {
                const detailTr = document.createElement('tr');
                detailTr.id = `detail-${item.tokenId}`;
                detailTr.className = "hidden bg-gray-50 detail-row border-b border-gray-200";
                
                // æ ¹æ®æ•°é‡æ’åºæ˜ç»†
                const sortedDetails = item.details.sort((a, b) => b.amount - a.amount);
                
                let detailRows = sortedDetails.map(d => `
                    <div class="flex justify-between items-center py-2 px-4 border-b border-gray-100 last:border-0 hover:bg-white rounded text-xs">
                        <span class="truncate max-w-[200px] md:max-w-[400px]">
                            ${formatAddressDisplay(d.address, d.remark)}
                        </span>
                        <span class="font-mono font-medium text-gray-700 ml-4 whitespace-nowrap">${d.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                    </div>
                `).join('');

                detailTr.innerHTML = `
                    <td colspan="5" class="p-4">
                        <div class="ml-8 bg-white border border-gray-200 rounded-lg shadow-sm p-2">
                            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-4 mt-1">
                                åœ°å€æŒä»“æ˜ç»† (å…± ${item.details.length} ä¸ªåœ°å€)
                            </h4>
                            <div class="max-h-64 overflow-y-auto custom-scrollbar">
                                ${detailRows}
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(detailTr);
            }
        }

        // å¯¼å‡º CSV åŠŸèƒ½
        function exportCSV() {
            if (!aggregatedDataForExport || aggregatedDataForExport.length === 0) return;

            const headers = ["MutilTitle", "TopicTitle", "Outcome", "TotalAmount", "Details"];
            const rows = aggregatedDataForExport.map(item => {
                // å°†æ˜ç»†æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²: "å¤‡æ³¨(åœ°å€): æ•°é‡ | ..."
                const detailsStr = item.details
                    .map(d => `${formatAddressExport(d.address, d.remark)}: ${d.amount}`)
                    .join(" | ");
                
                return [
                    `"${(item.mutilTitle || '').replace(/"/g, '""')}"`,
                    `"${(item.topicTitle || '').replace(/"/g, '""')}"`,
                    `"${item.outcomeLabel}"`,
                    item.totalAmount,
                    `"${detailsStr}"`
                ];
            });

            const csvContent = [
                headers.join(","),
                ...rows.map(e => e.join(","))
            ].join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `prediction_net_analysis_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>